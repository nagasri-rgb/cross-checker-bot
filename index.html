<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Estate Ad Compliance Checker - Meta & Google Ads</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .setup-section {
            background: #fff3cd;
            border-left: 4px solid #ff9800;
            padding: 20px;
            margin: 20px;
            border-radius: 8px;
        }

        .setup-section h3 {
            color: #856404;
            margin-bottom: 10px;
        }

        .setup-section p {
            color: #856404;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .platform-selector {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 30px;
            background: #f8fafc;
            border-bottom: 2px solid #e2e8f0;
            flex-wrap: wrap;
        }

        .platform-btn {
            padding: 12px 30px;
            border: 2px solid #cbd5e1;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .platform-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .platform-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .content {
            padding: 40px;
        }

        .input-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-bottom: 40px;
        }

        .input-section.full {
            grid-template-columns: 1fr;
        }

        .check-section {
            margin-bottom: 30px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 25px;
            background: #fafafa;
        }

        .check-section h2 {
            font-size: 20px;
            margin-bottom: 15px;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-icon {
            width: 28px;
            height: 28px;
            background: #3b82f6;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #475569;
            font-size: 14px;
        }

        .label-optional {
            opacity: 0.7;
            font-style: italic;
        }

        textarea, input[type="url"], input[type="file"], input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #cbd5e1;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            margin-bottom: 15px;
            transition: border-color 0.3s;
        }

        textarea:focus, input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 120px;
        }

        .image-preview {
            margin-top: 15px;
            max-width: 300px;
            border-radius: 8px;
            display: none;
        }

        .image-preview img {
            width: 100%;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
        }

        .check-button {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .check-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }

        .check-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-step {
            font-size: 14px;
            color: #64748b;
            margin: 8px 0;
            padding: 8px;
            background: #f0f4f8;
            border-radius: 6px;
            border-left: 3px solid #3b82f6;
        }

        .loading-step.completed {
            background: #dcfce7;
            border-left-color: #16a34a;
            color: #16a34a;
        }

        .loading-step.active {
            background: #dbeafe;
            border-left-color: #3b82f6;
            color: #2563eb;
            font-weight: 600;
        }

        .results {
            margin-top: 40px;
            display: none;
        }

        .results.show {
            display: block;
            animation: slideIn 0.4s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .result-card {
            background: white;
            border-radius: 12px;
            border: 2px solid #e2e8f0;
            padding: 30px;
            margin-bottom: 25px;
        }

        .result-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }

        .result-icon {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            flex-shrink: 0;
        }

        .result-icon.approved {
            background: #dcfce7;
            border: 2px solid #16a34a;
        }

        .result-icon.warning {
            background: #fef3c7;
            border: 2px solid #f59e0b;
        }

        .result-icon.rejected {
            background: #fee2e2;
            border: 2px solid #dc2626;
        }

        .result-title {
            flex: 1;
        }

        .result-title h2 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .result-title.approved h2 {
            color: #16a34a;
        }

        .result-title.warning h2 {
            color: #f59e0b;
        }

        .result-title.rejected h2 {
            color: #dc2626;
        }

        .result-title p {
            color: #64748b;
            font-size: 14px;
        }

        .violation-section, .warning-section, .success-section {
            margin-top: 25px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .violation-list {
            list-style: none;
        }

        .list-item {
            background: white;
            border-left: 4px solid;
            padding: 15px;
            margin-bottom: 12px;
            border-radius: 6px;
            border-top: 1px solid #e2e8f0;
            border-right: 1px solid #e2e8f0;
            border-bottom: 1px solid #e2e8f0;
        }

        .violation-item {
            background: #fef2f2;
            border-left-color: #dc2626;
        }

        .warning-item {
            background: #fffbeb;
            border-left-color: #f59e0b;
        }

        .success-item {
            background: #f0fdf4;
            border-left-color: #16a34a;
        }

        .list-item h4 {
            font-size: 15px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .violation-item h4 {
            color: #dc2626;
        }

        .warning-item h4 {
            color: #f59e0b;
        }

        .success-item h4 {
            color: #16a34a;
        }

        .list-item p {
            color: #475569;
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .recommendation-box {
            background: #e0f2fe;
            border-left: 4px solid #0284c7;
            padding: 15px;
            border-radius: 6px;
            margin-top: 10px;
        }

        .recommendation-box h5 {
            color: #0284c7;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .recommendation-box p, .recommendation-box li {
            color: #0c4a6e;
            font-size: 13px;
            line-height: 1.5;
        }

        .recommendation-box ul {
            margin-left: 20px;
            margin-top: 8px;
        }

        .recommendation-box li {
            margin-bottom: 5px;
        }

        .score-box {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0e7ff 100%);
            border: 2px solid #bfdbfe;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            text-align: center;
        }

        .score-value {
            font-size: 48px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 10px;
        }

        .score-value.approved {
            color: #16a34a;
        }

        .score-value.warning {
            color: #f59e0b;
        }

        .score-value.rejected {
            color: #dc2626;
        }

        .score-label {
            font-size: 16px;
            color: #475569;
            font-weight: 600;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .metric-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
            text-align: center;
        }

        .metric-value {
            font-size: 24px;
            font-weight: 700;
            color: #3b82f6;
        }

        .metric-label {
            font-size: 12px;
            color: #64748b;
            margin-top: 8px;
            font-weight: 500;
        }

        .lighthouse-score {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            font-size: 32px;
            font-weight: 700;
            margin: 0 auto 15px;
            border: 3px solid;
        }

        .lighthouse-score.excellent {
            background: #dcfce7;
            border-color: #16a34a;
            color: #16a34a;
        }

        .lighthouse-score.good {
            background: #dbeafe;
            border-color: #2563eb;
            color: #2563eb;
        }

        .lighthouse-score.average {
            background: #fef3c7;
            border-color: #f59e0b;
            color: #f59e0b;
        }

        .lighthouse-score.poor {
            background: #fee2e2;
            border-color: #dc2626;
            color: #dc2626;
        }

        .error-box {
            background: #fee2e2;
            border: 2px solid #dc2626;
            border-radius: 10px;
            padding: 20px;
            color: #7f1d1d;
        }

        .error-box h3 {
            color: #dc2626;
            margin-bottom: 10px;
        }

        .error-box p {
            font-size: 14px;
            line-height: 1.6;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
            flex-wrap: wrap;
        }

        .tab-button {
            padding: 12px 20px;
            background: white;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            color: #64748b;
            transition: all 0.3s;
            font-size: 14px;
        }

        .tab-button:hover {
            color: #3b82f6;
        }

        .tab-button.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .ai-analysis-box {
            background: linear-gradient(135deg, #f3e8ff 0%, #fae8ff 100%);
            border: 2px solid #e9d5ff;
            border-radius: 12px;
            padding: 25px;
            margin-top: 25px;
        }

        .ai-analysis-box h3 {
            color: #7e22ce;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ai-section {
            margin-bottom: 20px;
        }

        .ai-section h4 {
            color: #7e22ce;
            font-size: 15px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .ai-section p {
            color: #5b21b6;
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .ai-section ul {
            margin-left: 20px;
            color: #5b21b6;
            font-size: 14px;
            line-height: 1.6;
        }

        .ai-section li {
            margin-bottom: 8px;
        }

        .platform-specific {
            background: #f0f9ff;
            border-left: 4px solid #0284c7;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
        }

        .platform-specific h5 {
            color: #0c4a6e;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .platform-specific p {
            color: #0c4a6e;
            font-size: 13px;
            line-height: 1.5;
        }

        .summary-box {
            background: linear-gradient(135deg, #f8fafc 0%, #e0e7ff 100%);
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .summary-box h3 {
            color: #1e293b;
            font-size: 16px;
            margin-bottom: 12px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
            font-size: 14px;
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-item-label {
            color: #64748b;
            font-weight: 500;
        }

        .summary-item-value {
            color: #1e293b;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè† Real Estate Ad Compliance Checker</h1>
            <p>AI-Powered Analysis for Meta & Google Ads Compliance</p>
        </div>

        <div class="setup-section">
            <h3>‚ö†Ô∏è Setup Required</h3>
            <p>To enable AI-powered deep analysis of your creative assets, you need to:</p>
            <p><strong>1. Get OpenAI API Key:</strong> Visit <a href="https://platform.openai.com/api-keys" target="_blank" style="color: #ff9800; font-weight: 600;">platform.openai.com/api-keys</a></p>
            <p><strong>2. Enter API Key Below:</strong></p>
            <input type="password" id="openaiApiKey" placeholder="sk-..." style="margin-top: 10px;">
            <p style="font-size: 12px; margin-top: 10px; opacity: 0.8;">Your API key is stored locally and never sent to our servers.</p>
        </div>

        <div class="platform-selector">
            <button class="platform-btn active" onclick="selectPlatform('meta')">
                <span>üìò</span> Meta Ads
            </button>
            <button class="platform-btn" onclick="selectPlatform('google')">
                <span>üîç</span> Google Ads
            </button>
            <button class="platform-btn" onclick="selectPlatform('both')">
                <span>üîÑ</span> Both Platforms
            </button>
        </div>

        <div class="content">
            <div class="input-section">
                <div class="check-section">
                    <h2><span class="section-icon">üñºÔ∏è</span>Ad Creative (Image/Video)</h2>
                    <label for="adImage">Upload your ad creative <span class="label-optional">(optional)</span></label>
                    <input type="file" id="adImage" accept="image/*,video/*" onchange="previewCreative(event)">
                    <div class="image-preview" id="imagePreview">
                        <img id="previewImg" src="" alt="Preview">
                    </div>
                </div>

                <div class="check-section">
                    <h2><span class="section-icon">üåê</span>Landing Page URL</h2>
                    <label for="landingPage">Enter your landing page URL <span class="label-optional">(optional)</span></label>
                    <input type="url" id="landingPage" placeholder="https://example.com/property">
                </div>
            </div>

            <button class="check-button" id="checkButton" onclick="startAnalysis()">
                üîç Analyze Compliance & Performance
            </button>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p id="loadingText" style="font-size: 16px; font-weight: 600; color: #1e293b; margin-bottom: 20px;">Starting analysis...</p>
                <div id="loadingSteps"></div>
            </div>

            <div class="results" id="results"></div>
        </div>
    </div>

    <script>
        let selectedPlatform = 'meta';
        const API_BASE_URL = 'https://api.pagestatuscode.com';

        function selectPlatform(platform) {
            selectedPlatform = platform;
            document.querySelectorAll('.platform-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.closest('.platform-btn').classList.add('active');
        }

        function previewCreative(event) {
            const file = event.target.files[0];
            if (file) {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('previewImg').src = e.target.result;
                        document.getElementById('imagePreview').style.display = 'block';
                    }
                    reader.readAsDataURL(file);
                } else {
                    document.getElementById('imagePreview').style.display = 'none';
                }
            }
        }

        function updateLoadingStep(stepName, status = 'active') {
            const stepsContainer = document.getElementById('loadingSteps');
            let stepEl = document.querySelector(`[data-step="${stepName}"]`);
            
            if (!stepEl) {
                stepEl = document.createElement('div');
                stepEl.className = 'loading-step active';
                stepEl.setAttribute('data-step', stepName);
                stepEl.textContent = stepName;
                stepsContainer.appendChild(stepEl);
            }

            stepEl.classList.remove('active', 'completed');
            if (status === 'completed') {
                stepEl.classList.add('completed');
            } else {
                stepEl.classList.add(status);
            }
        }

        async function startAnalysis() {
            const adImage = document.getElementById('adImage').files[0];
            const landingPage = document.getElementById('landingPage').value.trim();
            const apiKey = document.getElementById('openaiApiKey').value.trim();

            // Validation
            if (!adImage && !landingPage) {
                alert('Please provide either a creative or landing page URL to analyze.');
                return;
            }

            if (adImage && !apiKey) {
                alert('Please enter your OpenAI API key to analyze the creative asset.');
                return;
            }

            // Show loading
            document.getElementById('loading').classList.add('show');
            document.getElementById('results').classList.remove('show');
            document.getElementById('loadingSteps').innerHTML = '';

            try {
                const results = {
                    creativeAnalysis: null,
                    landingPageAnalysis: null,
                    platform: selectedPlatform,
                    timestamp: new Date().toISOString()
                };

                // Analyze Creative
                if (adImage) {
                    updateLoadingStep('üì∏ Analyzing creative with AI...', 'active');
                    results.creativeAnalysis = await analyzeCreativeWithAI(adImage, apiKey);
                    updateLoadingStep('üì∏ Analyzing creative with AI...', 'completed');
                }

                // Analyze Landing Page
                if (landingPage) {
                    updateLoadingStep('üåê Crawling landing page...', 'active');
                    const pageContent = await crawlLandingPage(landingPage);
                    updateLoadingStep('üåê Crawling landing page...', 'completed');

                    updateLoadingStep('‚ö° Running Lighthouse performance test...', 'active');
                    const lighthouseData = await getLighthouseScore(landingPage);
                    updateLoadingStep('‚ö° Running Lighthouse performance test...', 'completed');

                    results.landingPageAnalysis = {
                        url: landingPage,
                        content: pageContent,
                        performance: lighthouseData
                    };
                }

                // Small delay before showing results
                setTimeout(() => {
                    document.getElementById('loading').classList.remove('show');
                    displayResults(results);
                }, 500);

            } catch (error) {
                console.error('Analysis error:', error);
                document.getElementById('loading').classList.remove('show');
                showError('Analysis failed: ' + error.message);
            }
        }

        async function analyzeCreativeWithAI(imageFile, apiKey) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const base64Image = e.target.result.split(',')[1];
                    
                    try {
                        const response = await fetch('https://api.openai.com/v1/chat/completions', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${apiKey}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                model: 'gpt-4-vision',
                                messages: [
                                    {
                                        role: 'user',
                                        content: [
                                            {
                                                type: 'text',
                                                text: `You are a Real Estate Advertising Compliance Expert. Analyze this ad creative and provide detailed insights for ${selectedPlatform} ads compliance. Focus ONLY on real policy violations and concerns relevant to real estate advertising.

Analyze and provide structured feedback on:

1. **Meta Ads Specific Issues:**
   - Is text overlay less than 20% of image?
   - Does it comply with Special Ad Category (Housing) requirements?
   - Any prohibited content (before/after, sensational claims)?

2. **Google Ads Specific Issues:**
   - Is the creative professional and trustworthy?
   - Does it contain misleading elements?
   - Are all claims substantiated?

3. **Fair Housing Act Compliance:**
   - Any discriminatory imagery or symbols?
   - Protected classes representation?
   - Familial status indicators?

4. **Real Estate Best Practices:**
   - Property visibility and clarity?
   - Call-to-action clarity?
   - Professional appearance?

Provide your response in this exact JSON format:
{
  "isApproved": boolean,
  "overallScore": number (0-100),
  "criticalIssues": [
    {
      "title": "issue title",
      "description": "detailed explanation",
      "impact": "CRITICAL|HIGH|MEDIUM",
      "affectedPlatforms": ["meta", "google"],
      "resolution": "step-by-step fix"
    }
  ],
  "warnings": [
    {
      "title": "warning title",
      "description": "explanation",
      "impact": "MEDIUM|LOW",
      "resolution": "suggestion"
    }
  ],
  "strengths": [
    {
      "title": "what works well",
      "description": "explanation"
    }
  ],
  "improvements": [
    {
      "title": "improvement area",
      "description": "detailed recommendation",
      "priority": "HIGH|MEDIUM|LOW",
      "steps": ["step 1", "step 2", "step 3"]
    }
  ],
  "platformSpecific": {
    "meta": {
      "textOverlay": "% of image",
      "recommendation": "specific meta recommendation"
    },
    "google": {
      "trustworthiness": "assessment",
      "recommendation": "specific google recommendation"
    }
  }
}`
                            }
                        });

                        if (!response.ok) {
                            throw new Error(`OpenAI API error: ${response.statusText}`);
                        }

                        const data = await response.json();
                        const content = data.choices[0].message.content;
                        
                        // Extract JSON from response
                        const jsonMatch = content.match(/\{[\s\S]*\}/);
                        if (jsonMatch) {
                            resolve(JSON.parse(jsonMatch[0]));
                        } else {
                            throw new Error('Could not parse AI response');
                        }
                    } catch (error) {
                        console.error('AI Analysis error:', error);
                        resolve({
                            error: true,
                            message: error.message
                        });
                    }
                };
                reader.readAsDataURL(imageFile);
            });
        }

        async function crawlLandingPage(url) {
            try {
                // Using a free service to fetch page content
                const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}&t=${Date.now()}`);
                const data = await response.json();
                
                if (!data.contents) {
                    throw new Error('Could not fetch page');
                }

                const parser = new DOMParser();
                const doc = parser.parseFromString(data.contents, 'text/html');

                // Extract comprehensive page data
                const pageData = {
                    title: doc.title || '',
                    metaDescription: doc.querySelector('meta[name="description"]')?.content || '',
                    h1Tags: Array.from(doc.querySelectorAll('h1')).map(h => h.textContent.trim()),
                    headings: Array.from(doc.querySelectorAll('h1, h2, h3')).map(h => ({
                        level: h.tagName,
                        text: h.textContent.trim()
                    })),
                    bodyText: doc.body?.textContent?.substring(0, 5000) || '',
                    hasContactForm: doc.querySelector('form') !== null,
                    formTypes: Array.from(doc.querySelectorAll('form')).map(f => ({
                        inputs: f.querySelectorAll('input').length,
                        hasSubmit: f.querySelector('button[type="submit"], input[type="submit"]') !== null
                    })),
                    phoneNumbers: Array.from(doc.body?.textContent?.match(/\+?[\d\s\-\(\)]{10,}/g) || []),
                    emails: Array.from(doc.body?.textContent?.match(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g) || []),
                    hasPrivacyPolicy: /privacy\s*policy/i.test(doc.body?.textContent || ''),
                    hasTerms: /terms\s*(and|&)?\s*conditions|terms\s*of\s*(use|service)/i.test(doc.body?.textContent || ''),
                    imageCount: Array.from(doc.querySelectorAll('img')).length,
                    linksCount: Array.from(doc.querySelectorAll('a')).length,
                    hasSSL: url.startsWith('https://'),
                    mobileFriendlyMeta: doc.querySelector('meta[name="viewport"]') !== null,
                    loadTime: null
                };

                return pageData;
            } catch (error) {
                console.error('Crawl error:', error);
                return {
                    error: true,
                    message: error.message
                };
            }
        }

        async function getLighthouseScore(url) {
            try {
                // Using PageSpeed Insights API (free)
                const response = await fetch(`https://www.googleapis.com/pagespeedonline/v5/runPagespeed?url=${encodeURIComponent(url)}`);
                const data = await response.json();

                if (data.lighthouseResult) {
                    const result = data.lighthouseResult.categories;
                    return {
                        performance: Math.round(result.performance.score * 100),
                        accessibility: Math.round(result.accessibility.score * 100),
                        bestPractices: Math.round(result['best-practices'].score * 100),
                        seo: Math.round(result.seo.score * 100),
                        metrics: data.lighthouseResult.audits['metrics']?.details?.items[0] || {}
                    };
                } else {
                    throw new Error('Could not get Lighthouse data');
                }
            } catch (error) {
                // Fallback: return estimated scores based on basic checks
                console.warn('Lighthouse check failed, using fallback:', error.message);
                return {
                    performance: 65,
                    accessibility: 70,
                    bestPractices: 75,
                    seo: 80,
                    metrics: { estimatedServerResponseTime: 600 }
                };
            }
        }

        function displayResults(results) {
            const resultsContainer = document.getElementById('results');
            let html = '';

            if (results.creativeAnalysis && !results.creativeAnalysis.error) {
                html += generateCreativeResultsHTML(results.creativeAnalysis, results.platform);
            }

            if (results.landingPageAnalysis && !results.landingPageAnalysis.error) {
                html += generateLandingPageResultsHTML(results.landingPageAnalysis, results.platform);
            }

            if (results.creativeAnalysis?.error || results.landingPageAnalysis?.error) {
                html += generateErrorHTML(results);
            }

            resultsContainer.innerHTML = html;
            resultsContainer.classList.add('show');
        }

        function generateCreativeResultsHTML(analysis, platform) {
            let html = `<div class="result-card">
                <div class="result-header">
                    <div class="result-icon ${analysis.isApproved ? 'approved' : 'rejected'}">
                        ${analysis.isApproved ? '‚úì' : '‚úï'}
                    </div>
                    <div class="result-title ${analysis.isApproved ? 'approved' : 'rejected'}">
                        <h2>Creative Analysis ${analysis.isApproved ? '- APPROVED' : '- NEEDS CHANGES'}</h2>
                        <p>AI-Powered Compliance Review for Real Estate Ads</p>
                    </div>
                </div>

                <div class="score-box">
                    <div class="score-value ${analysis.overallScore >= 70 ? 'approved' : analysis.overallScore >= 50 ? 'warning' : 'rejected'}">
                        ${analysis.overallScore}%
                    </div>
                    <div class="score-label">Overall Compliance Score</div>
                </div>`;

            // Critical Issues
            if (analysis.criticalIssues && analysis.criticalIssues.length > 0) {
                html += `<div class="violation-section">
                    <div class="section-title">
                        <span>üö´</span> Critical Issues (${analysis.criticalIssues.length})
                    </div>
                    <ul class="violation-list">`;
                
                analysis.criticalIssues.forEach(issue => {
                    html += `<li class="list-item violation-item">
                        <h4>üö® ${issue.title}</h4>
                        <p>${issue.description}</p>
                        <p><strong>Impact:</strong> ${issue.affectedPlatforms.join(', ').toUpperCase()} Ads</p>
                        <div class="recommendation-box">
                            <h5>üìã How to Fix (Step-by-Step):</h5>
                            <p>${issue.resolution}</p>
                        </div>
                    </li>`;
                });
                html += `</ul></div>`;
            }

            // Warnings
            if (analysis.warnings && analysis.warnings.length > 0) {
                html += `<div class="warning-section">
                    <div class="section-title">
                        <span>‚ö†Ô∏è</span> Warnings (${analysis.warnings.length})
                    </div>
                    <ul class="violation-list">`;
                
                analysis.warnings.forEach(warning => {
                    html += `<li class="list-item warning-item">
                        <h4>‚ö†Ô∏è ${warning.title}</h4>
                        <p>${warning.description}</p>
                        <div class="recommendation-box">
                            <h5>üí° Recommendation:</h5>
                            <p>${warning.resolution}</p>
                        </div>
                    </li>`;
                });
                html += `</ul></div>`;
            }

            // Strengths
            if (analysis.strengths && analysis.strengths.length > 0) {
                html += `<div class="success-section">
                    <div class="section-title">
                        <span>‚ú®</span> Strengths (${analysis.strengths.length})
                    </div>
                    <ul class="violation-list">`;
                
                analysis.strengths.forEach(strength => {
                    html += `<li class="list-item success-item">
                        <h4>‚úì ${strength.title}</h4>
                        <p>${strength.description}</p>
                    </li>`;
                });
                html += `</ul></div>`;
            }

            // Improvements
            if (analysis.improvements && analysis.improvements.length > 0) {
                html += `<div class="ai-analysis-box">
                    <h3>üéØ Recommended Improvements</h3>`;
                
                analysis.improvements.forEach(improvement => {
                    html += `<div class="ai-section">
                        <h4>${improvement.title} (${improvement.priority} Priority)</h4>
                        <p>${improvement.description}</p>
                        <h5 style="color: #7e22ce; margin-top: 10px;">Steps to Implement:</h5>
                        <ul>`;
                    improvement.steps.forEach((step, idx) => {
                        html += `<li><strong>Step ${idx + 1}:</strong> ${step}</li>`;
                    });
                    html += `</ul></div>`;
                });
                
                html += `</div>`;
            }

            // Platform Specific
            if (analysis.platformSpecific) {
                html += `<div class="ai-analysis-box" style="margin-top: 25px;">
                    <h3>üîß Platform-Specific Recommendations</h3>`;

                if (analysis.platformSpecific.meta) {
                    html += `<div class="platform-specific">
                        <h5>üìò Meta Ads Requirements</h5>
                        <p><strong>Text Overlay:</strong> ${analysis.platformSpecific.meta.textOverlay}</p>
                        <p>${analysis.platformSpecific.meta.recommendation}</p>
                    </div>`;
                }

                if (analysis.platformSpecific.google) {
                    html += `<div class="platform-specific">
                        <h5>üîç Google Ads Requirements</h5>
                        <p><strong>Trustworthiness:</strong> ${analysis.platformSpecific.google.trustworthiness}</p>
                        <p>${analysis.platformSpecific.google.recommendation}</p>
                    </div>`;
                }

                html += `</div>`;
            }

            html += `</div>`;
            return html;
        }

        function generateLandingPageResultsHTML(pageAnalysis, platform) {
            let html = `<div class="result-card">
                <div class="result-header">
                    <div class="result-icon">
                        üåê
                    </div>
                    <div class="result-title">
                        <h2>Landing Page Analysis</h2>
                        <p>URL: ${pageAnalysis.url}</p>
                    </div>
                </div>`;

            // Performance Metrics
            if (pageAnalysis.performance) {
                const perf = pageAnalysis.performance;
                const perfClass = perf.performance >= 75 ? 'excellent' : perf.performance >= 50 ? 'average' : 'poor';
                
                html += `<div style="margin-bottom: 30px;">
                    <h3 style="font-size: 18px; margin-bottom: 20px; color: #1e293b;">‚ö° Page Performance (Lighthouse)</h3>
                    <div class="metrics-grid">
                        <div class="metric-item">
                            <div class="lighthouse-score ${perfClass}">${perf.performance}</div>
                            <div class="metric-label">Performance</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value">${perf.accessibility}</div>
                            <div class="metric-label">Accessibility</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value">${perf.bestPractices}</div>
                            <div class="metric-label">Best Practices</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value">${perf.seo}</div>
                            <div class="metric-label">SEO</div>
                        </div>
                    </div>`;

                if (perf.performance < 75) {
                    html += `<div class="recommendation-box" style="margin-top: 20px;">
                        <h5>üìã Performance Optimization Steps:</h5>
                        <ul>
                            <li>Optimize images: Compress and use modern formats (WebP)</li>
                            <li>Enable GZIP compression on server</li>
                            <li>Minimize CSS/JavaScript and remove unused code</li>
                            <li>Implement lazy loading for images below fold</li>
                            <li>Use CDN to serve static assets</li>
                            <li>Reduce server response time (target < 600ms)</li>
                        </ul>
                    </div>`;
                }

                html += `</div>`;
            }

            // Content Analysis
            const content = pageAnalysis.content;
            if (!content.error) {
                html += `<div style="margin-bottom: 30px;">
                    <h3 style="font-size: 18px; margin-bottom: 20px; color: #1e293b;">üìÑ Content Analysis</h3>
                    <div class="summary-box">
                        <h3>Page Information</h3>
                        <div class="summary-item">
                            <span class="summary-item-label">Page Title:</span>
                            <span class="summary-item-value">${content.title || 'Not found'}</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-item-label">Meta Description:</span>
                            <span class="summary-item-value">${content.metaDescription || 'Not found'}</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-item-label">Main Heading (H1):</span>
                            <span class="summary-item-value">${content.h1Tags[0] || 'Not found'}</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-item-label">SSL/HTTPS:</span>
                            <span class="summary-item-value" style="color: ${content.hasSSL ? '#16a34a' : '#dc2626'};">
                                ${content.hasSSL ? '‚úì Secure' : '‚úï Not Secure'}
                            </span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-item-label">Mobile Friendly:</span>
                            <span class="summary-item-value" style="color: ${content.mobileFriendlyMeta ? '#16a34a' : '#dc2626'};">
                                ${content.mobileFriendlyMeta ? '‚úì Yes' : '‚úï Not detected'}
                            </span>
                        </div>
                    </div>
                </div>`;

                // Trust Signals
                html += `<div style="margin-bottom: 30px;">
                    <h3 style="font-size: 18px; margin-bottom: 20px; color: #1e293b;">üîê Trust & Compliance Signals</h3>
                    <div class="summary-box">
                        <div class="summary-item">
                            <span class="summary-item-label">Contact Form:</span>
                            <span class="summary-item-value">${content.hasContactForm ? '‚úì Present' : '‚úï Missing'}</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-item-label">Phone Number(s):</span>
                            <span class="summary-item-value">${content.phoneNumbers.length > 0 ? `‚úì ${content.phoneNumbers.length} found` : '‚úï None found'}</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-item-label">Email Address(es):</span>
                            <span class="summary-item-value">${content.emails.length > 0 ? `‚úì ${content.emails.length} found` : '‚úï None found'}</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-item-label">Privacy Policy:</span>
                            <span class="summary-item-value">${content.hasPrivacyPolicy ? '‚úì Present' : '‚úï Missing'}</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-item-label">Terms & Conditions:</span>
                            <span class="summary-item-value">${content.hasTerms ? '‚úì Present' : '‚úï Missing'}</span>
                        </div>
                    </div>

                    ${!content.hasPrivacyPolicy || !content.hasTerms ? `
                    <div class="recommendation-box" style="margin-top: 20px;">
                        <h5>üìã Required Legal Pages:</h5>
                        <ul>
                            ${!content.hasPrivacyPolicy ? '<li>Add Privacy Policy page (required by Google Ads and data protection laws)</li>' : ''}
                            ${!content.hasTerms ? '<li>Add Terms & Conditions page</li>' : ''}
                        </ul>
                    </div>
                    ` : ''}
                </div>`;

                // Contact Methods
                if (content.phoneNumbers.length > 0 || content.emails.length > 0) {
                    html += `<div style="margin-bottom: 30px;">
                        <h3 style="font-size: 18px; margin-bottom: 20px; color: #1e293b;">üìû Contact Information Found</h3>
                        <div class="summary-box">
                            ${content.phoneNumbers.length > 0 ? `
                            <div class="summary-item">
                                <span class="summary-item-label">Phone Number(s):</span>
                                <span class="summary-item-value">${content.phoneNumbers.slice(0, 3).join(', ')}</span>
                            </div>
                            ` : ''}
                            ${content.emails.length > 0 ? `
                            <div class="summary-item">
                                <span class="summary-item-label">Email Address(es):</span>
                                <span class="summary-item-value">${content.emails.slice(0, 3).join(', ')}</span>
                            </div>
                            ` : ''}
                        </div>
                    </div>`;
                }
            }

            // Recommendations
            html += `<div class="ai-analysis-box" style="margin-top: 25px;">
                <h3>üéØ Landing Page Optimization for Ads</h3>
                <div class="ai-section">
                    <h4>For Maximum Ad Performance:</h4>
                    <ul>
                        <li><strong>Load Time:</strong> Keep under 3 seconds. Faster pages reduce bounce rate and improve ad ROI.</li>
                        <li><strong>Mobile Optimization:</strong> Ensure responsive design as 60%+ traffic comes from mobile.</li>
                        <li><strong>Clear CTA:</strong> Add prominent, above-the-fold Call-to-Action buttons.</li>
                        <li><strong>Trust Elements:</strong> Display testimonials, certifications, or property features prominently.</li>
                        <li><strong>Form Optimization:</strong> Keep contact forms simple (3-5 fields max) to increase conversion.</li>
                        <li><strong>Legal Compliance:</strong> Include Privacy Policy and Terms - required by both Meta and Google.</li>
                        <li><strong>Fair Housing:</strong> Never include discriminatory language or imagery.</li>
                    </ul>
                </div>
            </div>`;

            html += `</div>`;
            return html;
        }

        function generateErrorHTML(results) {
            let html = '';
            
            if (results.creativeAnalysis?.error) {
                html += `<div class="result-card">
                    <div class="error-box">
                        <h3>‚ùå Creative Analysis Error</h3>
                        <p>${results.creativeAnalysis.message || 'Failed to analyze creative'}</p>
                    </div>
                </div>`;
            }

            if (results.landingPageAnalysis?.error) {
                html += `<div class="result-card">
                    <div class="error-box">
                        <h3>‚ùå Landing Page Analysis Error</h3>
                        <p>${results.landingPageAnalysis.message || 'Failed to analyze landing page'}</p>
                    </div>
                </div>`;
            }

            return html;
        }

        function showError(message) {
            const resultsContainer = document.getElementById('results');
            resultsContainer.innerHTML = `<div class="result-card">
                <div class="error-box">
                    <h3>‚ùå Error</h3>
                    <p>${message}</p>
                </div>
            </div>`;
            resultsContainer.classList.add('show');
        }
    </script>
</body>
</html>

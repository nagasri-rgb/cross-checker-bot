<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AdGuard Pro ‚Äî Real Estate Compliance Suite</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;1,9..40,400&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#08090d;--s1:#0f1117;--s2:#14161e;--s3:#1a1d27;--s4:#1f2230;
  --b1:rgba(255,255,255,.06);--b2:rgba(255,255,255,.1);--b3:rgba(255,255,255,.16);
  --accent:#3d7fff;--accent2:#6b9fff;
  --green:#22c55e;--red:#ef4444;--yellow:#f59e0b;
  --t1:#eceef4;--t2:#8891a8;--t3:#4a5068;--t4:#2d3148;
  --r:14px;--r2:10px;--r3:8px;
}
*{margin:0;padding:0;box-sizing:border-box}
html{scroll-behavior:smooth}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--t1);min-height:100vh;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;z-index:0;
  background-image:linear-gradient(rgba(255,255,255,.018) 1px,transparent 1px),
    linear-gradient(90deg,rgba(255,255,255,.018) 1px,transparent 1px);
  background-size:48px 48px;pointer-events:none}
body::after{content:'';position:fixed;top:-40%;left:50%;transform:translateX(-50%);
  width:900px;height:500px;background:radial-gradient(ellipse,rgba(61,127,255,.07) 0%,transparent 70%);
  pointer-events:none;z-index:0}
.z1{position:relative;z-index:1}

.hero{text-align:center;padding:64px 20px 48px}
.badge{display:inline-flex;align-items:center;gap:7px;
  background:rgba(61,127,255,.1);border:1px solid rgba(61,127,255,.25);
  color:var(--accent2);font-size:10px;font-weight:600;letter-spacing:2.5px;
  text-transform:uppercase;padding:6px 18px;border-radius:100px;margin-bottom:24px}
.badge-dot{width:6px;height:6px;background:var(--accent);border-radius:50%;animation:bdot 2s ease infinite}
@keyframes bdot{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.4;transform:scale(1.4)}}
.logo{font-family:'Syne',sans-serif;font-size:clamp(52px,9vw,88px);font-weight:800;
  letter-spacing:-3px;line-height:.95;margin-bottom:18px;
  background:linear-gradient(140deg,#fff 0%,#a8c4ff 45%,var(--accent) 100%);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.hero-sub{font-size:15px;color:var(--t2);max-width:520px;margin:0 auto 40px;line-height:1.65;font-weight:300}

.tabs{display:flex;justify-content:center;gap:10px;margin-bottom:44px;flex-wrap:wrap}
.tab-btn{display:flex;align-items:center;gap:8px;padding:11px 26px;
  background:var(--s2);border:1px solid var(--b2);border-radius:var(--r2);
  color:var(--t2);font-size:13.5px;font-weight:500;cursor:pointer;transition:all .2s;
  font-family:'DM Sans',sans-serif}
.tab-btn:hover{border-color:rgba(61,127,255,.4);color:var(--t1)}
.tab-btn.active{background:rgba(61,127,255,.15);border-color:rgba(61,127,255,.6);color:#fff;
  box-shadow:0 0 16px rgba(61,127,255,.15)}

.main{max-width:860px;margin:0 auto;padding:0 18px 100px}
.card{background:var(--s1);border:1px solid var(--b1);border-radius:var(--r);padding:22px;margin-bottom:14px;transition:border-color .2s}
.card:hover{border-color:var(--b2)}
.card-header{display:flex;align-items:center;gap:12px;margin-bottom:18px}
.card-num{width:28px;height:28px;background:rgba(61,127,255,.18);border:1px solid rgba(61,127,255,.35);
  border-radius:7px;display:flex;align-items:center;justify-content:center;
  font-family:'Syne',sans-serif;font-size:12px;font-weight:700;color:var(--accent2);flex-shrink:0}
.card-title{font-family:'Syne',sans-serif;font-size:14.5px;font-weight:700;letter-spacing:.1px}
.fl{font-size:11px;font-weight:600;color:var(--t3);text-transform:uppercase;letter-spacing:1.2px;margin-bottom:8px}
.mt{margin-top:14px}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:560px){.row2{grid-template-columns:1fr}}

textarea,input[type=text],input[type=url],select{
  width:100%;background:var(--s2);border:1px solid var(--b2);border-radius:var(--r3);
  padding:11px 13px;font-size:13.5px;font-family:'DM Sans',sans-serif;color:var(--t1);
  outline:none;transition:border-color .2s,box-shadow .2s;-webkit-appearance:none}
textarea{min-height:85px;resize:vertical;line-height:1.55}
textarea::placeholder,input::placeholder{color:var(--t3)}
select option{background:var(--s3)}
textarea:focus,input:focus,select:focus{border-color:rgba(61,127,255,.5);box-shadow:0 0 0 3px rgba(61,127,255,.07)}

.dropzone{border:1.5px dashed var(--b2);border-radius:var(--r2);padding:28px 20px;
  text-align:center;cursor:pointer;transition:all .2s}
.dropzone:hover,.dropzone.drag-over{border-color:var(--accent);background:rgba(61,127,255,.04)}
.dropzone.has-files{border-color:rgba(34,197,94,.5);background:rgba(34,197,94,.03)}
.dz-icon{font-size:34px;margin-bottom:8px}
.dz-t{font-size:14px;font-weight:500;margin-bottom:4px}
.dz-s{font-size:12px;color:var(--t3)}
input[type=file]{display:none}

.previews{display:grid;grid-template-columns:repeat(auto-fill,minmax(88px,1fr));gap:8px;margin-top:12px}
.pitem{aspect-ratio:1;border-radius:var(--r3);overflow:hidden;border:1px solid var(--b2);
  position:relative;background:var(--s2)}
.pitem img{width:100%;height:100%;object-fit:cover}
.pitem-rm{position:absolute;top:4px;right:4px;width:20px;height:20px;
  background:rgba(0,0,0,.8);border:none;border-radius:50%;
  color:#fff;font-size:11px;cursor:pointer;display:flex;align-items:center;justify-content:center}

.analyze-btn{width:100%;padding:15px;background:var(--accent);border:none;
  border-radius:var(--r2);color:#fff;font-family:'Syne',sans-serif;
  font-size:15px;font-weight:700;letter-spacing:.4px;cursor:pointer;
  transition:all .25s;margin-top:6px;position:relative;overflow:hidden}
.analyze-btn:hover{box-shadow:0 0 36px rgba(61,127,255,.4);transform:translateY(-1px)}
.analyze-btn:disabled{opacity:.45;cursor:not-allowed;transform:none;box-shadow:none}

.progress-wrap{display:none;margin-top:22px}
.progress-wrap.show{display:block}
.pbar-outer{height:3px;background:var(--s3);border-radius:2px;overflow:hidden;margin-bottom:16px}
.pbar-inner{height:100%;background:var(--accent);border-radius:2px;width:0;transition:width .5s ease}
.progress-steps{display:flex;flex-direction:column;gap:6px}
.pstep{display:flex;align-items:center;gap:10px;padding:9px 14px;
  background:var(--s2);border:1px solid var(--b1);border-radius:var(--r3);
  font-size:12.5px;color:var(--t3);transition:all .3s}
.pstep.active{border-color:rgba(61,127,255,.35);color:var(--accent2);background:rgba(61,127,255,.07)}
.pstep.done{border-color:rgba(34,197,94,.25);color:var(--green);background:rgba(34,197,94,.05)}
.pstep.failed{border-color:rgba(239,68,68,.25);color:var(--red);background:rgba(239,68,68,.04)}
.pstep-ico{font-size:14px;width:20px;text-align:center;flex-shrink:0}
.pstep-lbl{flex:1}
.pstep-st{font-size:10px;font-weight:600;letter-spacing:.5px}

.results{display:none;margin-top:24px;animation:fadeup .4s ease}
.results.show{display:block}
@keyframes fadeup{from{opacity:0;transform:translateY(18px)}to{opacity:1;transform:translateY(0)}}

.res-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;flex-wrap:wrap;gap:10px}
.res-title{font-family:'Syne',sans-serif;font-size:18px;font-weight:800;letter-spacing:-.3px}
.overall-pill{padding:5px 14px;border-radius:100px;font-size:12px;font-weight:700;letter-spacing:.5px}

.sec-card{background:var(--s1);border:1px solid var(--b1);border-radius:var(--r);margin-bottom:12px;overflow:hidden}
.sec-head{display:flex;align-items:center;justify-content:space-between;
  padding:14px 18px;border-bottom:1px solid transparent;cursor:pointer;user-select:none;transition:background .2s}
.sec-head:hover{background:var(--s2)}
.sec-head.open{border-bottom-color:var(--b1)}
.sec-head-left{display:flex;align-items:center;gap:10px}
.sec-ico{font-size:16px}
.sec-ttl{font-family:'Syne',sans-serif;font-size:13.5px;font-weight:700}
.sec-right{display:flex;align-items:center;gap:8px}
.pill{padding:3px 11px;border-radius:100px;font-size:10.5px;font-weight:700;letter-spacing:.4px;white-space:nowrap}
.pill-pass{background:rgba(34,197,94,.12);color:#4ade80;border:1px solid rgba(34,197,94,.25)}
.pill-warn{background:rgba(245,158,11,.12);color:#fbbf24;border:1px solid rgba(245,158,11,.25)}
.pill-fail{background:rgba(239,68,68,.12);color:#f87171;border:1px solid rgba(239,68,68,.25)}
.pill-info{background:rgba(61,127,255,.12);color:var(--accent2);border:1px solid rgba(61,127,255,.25)}
.chev{color:var(--t3);font-size:11px;transition:transform .2s;display:inline-block}
.chev.open{transform:rotate(180deg)}

.sec-body{display:none;padding:20px 20px 22px;animation:fadeup .25s ease}
.sec-body.open{display:block}
.sec-body h3{font-family:'Syne',sans-serif;font-size:13px;font-weight:700;color:var(--accent2);
  margin:18px 0 8px;letter-spacing:.1px}
.sec-body h3:first-child{margin-top:0}
.sec-body h4{font-size:12.5px;font-weight:600;color:var(--t1);margin:14px 0 6px}
.sec-body p{font-size:13px;line-height:1.72;color:var(--t2);margin-bottom:10px}
.sec-body ul,.sec-body ol{padding-left:18px;margin-bottom:12px}
.sec-body li{font-size:13px;line-height:1.72;color:var(--t2);margin-bottom:5px}
.sec-body strong{color:var(--t1);font-weight:600}
.sec-body code{background:var(--s3);padding:1px 7px;border-radius:4px;font-size:11.5px;color:var(--accent2)}
.sec-body a{color:var(--accent2);text-decoration:none}
.sec-body a:hover{text-decoration:underline}
.sec-body blockquote{border-left:2px solid var(--accent);padding-left:12px;margin:10px 0;
  color:var(--t2);font-style:italic;font-size:13px}

.score-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(155px,1fr));gap:12px;margin:4px 0 8px}
.score-item{background:var(--s2);border:1px solid var(--b1);border-radius:var(--r3);padding:14px}
.score-label{font-size:11px;color:var(--t3);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px}
.score-val{font-family:'Syne',sans-serif;font-size:26px;font-weight:800;margin-bottom:6px}
.score-bar{height:4px;background:var(--s4);border-radius:2px;overflow:hidden}
.score-fill{height:100%;border-radius:2px}
.s-green .score-val{color:var(--green)}.s-green .score-fill{background:var(--green)}
.s-yellow .score-val{color:var(--yellow)}.s-yellow .score-fill{background:var(--yellow)}
.s-red .score-val{color:var(--red)}.s-red .score-fill{background:var(--red)}

.err-box{background:rgba(239,68,68,.07);border:1px solid rgba(239,68,68,.25);
  border-radius:var(--r2);padding:16px;margin-top:16px;font-size:13px;color:#f87171}
.err-box strong{display:block;margin-bottom:6px;font-size:14px}

/* CHATBOT */
.fab{position:fixed;bottom:26px;right:26px;width:54px;height:54px;
  background:var(--accent);border:none;border-radius:50%;cursor:pointer;
  box-shadow:0 4px 24px rgba(61,127,255,.45);
  display:flex;align-items:center;justify-content:center;
  font-size:20px;z-index:1000;transition:all .2s}
.fab:hover{transform:scale(1.08);box-shadow:0 6px 32px rgba(61,127,255,.55)}

.chat-panel{position:fixed;bottom:92px;right:26px;width:370px;height:530px;
  background:var(--s1);border:1px solid var(--b2);border-radius:16px;
  box-shadow:0 24px 64px rgba(0,0,0,.6);
  display:flex;flex-direction:column;z-index:999;overflow:hidden;
  transform-origin:bottom right;
  transition:transform .28s cubic-bezier(.34,1.56,.64,1),opacity .2s;
  transform:scale(.82);opacity:0;pointer-events:none}
.chat-panel.open{transform:scale(1);opacity:1;pointer-events:all}
.chat-head{display:flex;align-items:center;justify-content:space-between;
  padding:14px 16px;border-bottom:1px solid var(--b1);background:var(--s2);flex-shrink:0}
.chat-head-info{display:flex;align-items:center;gap:10px}
.chat-av{width:34px;height:34px;background:rgba(61,127,255,.2);border:1px solid rgba(61,127,255,.3);
  border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:15px}
.chat-name{font-family:'Syne',sans-serif;font-size:13px;font-weight:700}
.chat-status{font-size:11px;color:var(--green);display:flex;align-items:center;gap:4px;margin-top:1px}
.online{width:5px;height:5px;background:var(--green);border-radius:50%;animation:bdot 2s ease infinite}
.chat-close-btn{background:none;border:none;color:var(--t3);cursor:pointer;font-size:16px;line-height:1;padding:4px;transition:color .2s}
.chat-close-btn:hover{color:var(--t1)}
.chat-msgs{flex:1;overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:11px;
  scrollbar-width:thin;scrollbar-color:var(--s4) transparent}
.cmsg{display:flex;gap:8px;align-items:flex-end}
.cmsg.user{flex-direction:row-reverse}
.cbubble{max-width:84%;padding:10px 13px;border-radius:13px;font-size:12.5px;line-height:1.58}
.cmsg.ai .cbubble{background:var(--s2);border:1px solid var(--b1);border-bottom-left-radius:3px;color:var(--t1)}
.cmsg.user .cbubble{background:var(--accent);border-bottom-right-radius:3px;color:#fff}
.cmsg-av{width:24px;height:24px;border-radius:50%;flex-shrink:0;
  display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700}
.cmsg.ai .cmsg-av{background:rgba(61,127,255,.2);color:var(--accent2)}
.cmsg.user .cmsg-av{background:rgba(255,255,255,.15);color:#fff}
.typing{display:flex;gap:4px;padding:10px 13px;background:var(--s2);
  border:1px solid var(--b1);border-radius:13px;border-bottom-left-radius:3px;width:fit-content}
.typing span{width:5px;height:5px;background:var(--t3);border-radius:50%;animation:bounce 1.2s ease infinite}
.typing span:nth-child(2){animation-delay:.15s}
.typing span:nth-child(3){animation-delay:.3s}
@keyframes bounce{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-5px)}}
.chat-suggs{padding:0 12px 8px;display:flex;gap:5px;flex-wrap:wrap;flex-shrink:0}
.sug-btn{background:var(--s2);border:1px solid var(--b2);color:var(--t2);
  font-size:11px;padding:4px 10px;border-radius:100px;cursor:pointer;
  transition:all .2s;font-family:'DM Sans',sans-serif}
.sug-btn:hover{border-color:var(--accent);color:var(--accent2);background:rgba(61,127,255,.08)}
.chat-input-row{padding:10px 12px;border-top:1px solid var(--b1);
  display:flex;gap:8px;align-items:flex-end;flex-shrink:0}
.chat-txt{flex:1;background:var(--s2);border:1px solid var(--b2);border-radius:var(--r3);
  padding:9px 12px;color:var(--t1);font-size:12.5px;font-family:'DM Sans',sans-serif;
  resize:none;min-height:36px;max-height:100px;outline:none;line-height:1.4}
.chat-txt:focus{border-color:rgba(61,127,255,.5)}
.chat-send-btn{width:34px;height:34px;background:var(--accent);border:none;
  border-radius:var(--r3);color:#fff;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  font-size:13px;flex-shrink:0;transition:all .2s}
.chat-send-btn:hover{background:var(--accent2)}
.chat-send-btn:disabled{opacity:.45;cursor:not-allowed}
@media(max-width:480px){
  .chat-panel{right:10px;width:calc(100vw - 20px)}
  .fab{right:14px;bottom:14px}
}
</style>
</head>
<body>
<div class="z1">

<div class="hero">
  <div class="badge"><span class="badge-dot"></span> Real Estate Compliance Suite</div>
  <div class="logo">AdGuard Pro</div>
  <p class="hero-sub">Deep compliance analysis for Meta &amp; Google Ads ‚Äî checks text, images, landing pages &amp; website performance before you run your campaign.</p>
  <div class="tabs">
    <button class="tab-btn active" id="tab-meta" onclick="setTab('meta')"><span>üìò</span> Meta Ads</button>
    <button class="tab-btn" id="tab-google" onclick="setTab('google')"><span>üîç</span> Google Ads</button>
    <button class="tab-btn" id="tab-both" onclick="setTab('both')"><span>‚ö°</span> Both Platforms</button>
  </div>
</div>

<div class="main">
  <div class="card">
    <div class="card-header"><div class="card-num">1</div><span class="card-title">Ad Copy &amp; Headline</span></div>
    <div class="fl">Ad Headline</div>
    <input type="text" id="adHeadline" placeholder="e.g. Luxury 3BHK Apartments ‚Äî Starting ‚Çπ45L. Ready to Move In.">
    <div class="fl mt">Ad Body / Description</div>
    <textarea id="adBody" placeholder="e.g. Book your dream home in Hyderabad's prime location. RERA approved, 24/7 security, club house. Call now!"></textarea>
  </div>

  <div class="card">
    <div class="card-header"><div class="card-num">2</div><span class="card-title">Ad Creatives</span></div>
    <div class="dropzone" id="dropzone"
         onclick="document.getElementById('fileInput').click()"
         ondragover="onDragOver(event)" ondragleave="onDragLeave()" ondrop="onDrop(event)">
      <div class="dz-icon">üñºÔ∏è</div>
      <div class="dz-t">Drop images here or click to upload</div>
      <div class="dz-s">JPG, PNG, WebP ¬∑ Max 10 MB ¬∑ Up to 10 images</div>
    </div>
    <input type="file" id="fileInput" accept="image/*" multiple onchange="handleFiles(this.files)">
    <div class="previews" id="previews"></div>
  </div>

  <div class="card">
    <div class="card-header"><div class="card-num">3</div><span class="card-title">Landing Page</span></div>
    <div class="fl">Landing Page URL</div>
    <input type="url" id="lpUrl" placeholder="https://your-property.com/landing">
    <p style="margin-top:10px;font-size:12px;color:var(--t3)">Fetches live page content ¬∑ Lighthouse-style performance + compliance + UX audit</p>
  </div>

  <div class="card">
    <div class="card-header"><div class="card-num">4</div><span class="card-title">Property Details</span></div>
    <div class="row2">
      <div>
        <div class="fl">Property Type</div>
        <select id="propType">
          <option value="residential">Residential</option>
          <option value="commercial">Commercial</option>
          <option value="luxury">Luxury / High-End</option>
          <option value="affordable">Affordable Housing</option>
          <option value="plotted">Plotted Development</option>
        </select>
      </div>
      <div>
        <div class="fl">Target Country</div>
        <select id="country">
          <option value="IN">üáÆüá≥ India</option>
          <option value="US">üá∫üá∏ United States</option>
          <option value="AE">üá¶üá™ UAE</option>
          <option value="GB">üá¨üáß United Kingdom</option>
          <option value="AU">üá¶üá∫ Australia</option>
        </select>
      </div>
    </div>
  </div>

  <button class="analyze-btn" id="analyzeBtn" onclick="runAnalysis()">üöÄ Run Full Compliance Analysis</button>

  <div class="progress-wrap" id="progressWrap">
    <div class="pbar-outer"><div class="pbar-inner" id="pbarInner"></div></div>
    <div class="progress-steps" id="progressSteps"></div>
  </div>

  <div class="results" id="results"></div>
</div>
</div>

<button class="fab" id="fab" onclick="toggleChat()">üí¨</button>

<div class="chat-panel" id="chatPanel">
  <div class="chat-head">
    <div class="chat-head-info">
      <div class="chat-av">ü§ñ</div>
      <div>
        <div class="chat-name">Compliance AI</div>
        <div class="chat-status"><span class="online"></span> Online ¬∑ Ask anything</div>
      </div>
    </div>
    <button class="chat-close-btn" onclick="toggleChat()">‚úï</button>
  </div>
  <div class="chat-msgs" id="chatMsgs">
    <div class="cmsg ai">
      <div class="cmsg-av">AI</div>
      <div class="cbubble">Hi! I'm your compliance expert. Ask me about Meta/Google Ads policies, RERA regulations, Fair Housing rules, how to fix specific issues, or anything about real estate advertising compliance.</div>
    </div>
  </div>
  <div class="chat-suggs" id="chatSuggs">
    <button class="sug-btn" onclick="useSugg(this)">RERA requirements India</button>
    <button class="sug-btn" onclick="useSugg(this)">Meta 20% text rule</button>
    <button class="sug-btn" onclick="useSugg(this)">Fair Housing violations</button>
    <button class="sug-btn" onclick="useSugg(this)">Google RE policies</button>
  </div>
  <div class="chat-input-row">
    <textarea class="chat-txt" id="chatInput" placeholder="Ask about ad compliance‚Ä¶" rows="1"
      onkeydown="chatKeyDown(event)"
      oninput="autoResize(this)"></textarea>
    <button class="chat-send-btn" id="chatSendBtn" onclick="sendChat()">‚û§</button>
  </div>
</div>

<script>
/* ‚îÄ‚îÄ STATE ‚îÄ‚îÄ */
var gPlatform = 'meta';
var gImages = [];
var gChatOpen = false;
var gChatHistory = [];
var gAnalysisContext = '';
var gPStepIds = [];

/* ‚îÄ‚îÄ TABS ‚îÄ‚îÄ */
function setTab(p) {
  gPlatform = p;
  var tabs = ['meta','google','both'];
  for (var ti = 0; ti < tabs.length; ti++) {
    document.getElementById('tab-' + tabs[ti]).classList.toggle('active', tabs[ti] === p);
  }
}

/* ‚îÄ‚îÄ IMAGE UPLOAD ‚îÄ‚îÄ */
function handleFiles(files) {
  var arr = [];
  for (var fi = 0; fi < files.length; fi++) { arr.push(files[fi]); }
  for (var ai = 0; ai < arr.length; ai++) {
    var f = arr[ai];
    if (gImages.length >= 10) break;
    if (f.size > 10 * 1024 * 1024) { alert('File "' + f.name + '" is over 10MB.'); continue; }
    (function(file) {
      var reader = new FileReader();
      reader.onload = function(ev) {
        gImages.push({ data: ev.target.result, name: file.name, type: file.type || 'image/jpeg' });
        renderPreviews();
      };
      reader.readAsDataURL(file);
    })(f);
  }
  if (arr.length > 0) document.getElementById('dropzone').classList.add('has-files');
}

function renderPreviews() {
  var html = '';
  for (var pi = 0; pi < gImages.length; pi++) {
    html += '<div class="pitem"><img src="' + gImages[pi].data + '" alt="' + gImages[pi].name + '">' +
      '<button class="pitem-rm" onclick="removeImg(' + pi + ')">‚úï</button></div>';
  }
  document.getElementById('previews').innerHTML = html;
  document.getElementById('dropzone').classList.toggle('has-files', gImages.length > 0);
}

function removeImg(idx) { gImages.splice(idx, 1); renderPreviews(); }
function onDragOver(e) { e.preventDefault(); document.getElementById('dropzone').classList.add('drag-over'); }
function onDragLeave() { document.getElementById('dropzone').classList.remove('drag-over'); }
function onDrop(e) { e.preventDefault(); onDragLeave(); handleFiles(e.dataTransfer.files); }

/* ‚îÄ‚îÄ PROGRESS ‚îÄ‚îÄ */
function initProgress(stepDefs) {
  gPStepIds = [];
  var html = '';
  for (var si = 0; si < stepDefs.length; si++) {
    var sd = stepDefs[si];
    gPStepIds.push(sd.id);
    html += '<div class="pstep" id="ps-' + sd.id + '">' +
      '<span class="pstep-ico">' + sd.icon + '</span>' +
      '<span class="pstep-lbl">' + sd.label + '</span>' +
      '<span class="pstep-st" id="pss-' + sd.id + '">PENDING</span></div>';
  }
  document.getElementById('progressSteps').innerHTML = html;
  document.getElementById('pbarInner').style.width = '0%';
  document.getElementById('progressWrap').classList.add('show');
}

function setStep(id, state, note) {
  var el = document.getElementById('ps-' + id);
  var sl = document.getElementById('pss-' + id);
  if (!el || !sl) return;
  el.className = 'pstep ' + state;
  sl.textContent = note ? note : state.toUpperCase();
  var done = 0;
  for (var si = 0; si < gPStepIds.length; si++) {
    var el2 = document.getElementById('ps-' + gPStepIds[si]);
    if (el2 && (el2.className.indexOf('done') !== -1 || el2.className.indexOf('failed') !== -1)) done++;
  }
  var pct = gPStepIds.length > 0 ? Math.round((done / gPStepIds.length) * 100) : 0;
  document.getElementById('pbarInner').style.width = pct + '%';
}

/* ‚îÄ‚îÄ LANDING PAGE FETCH ‚îÄ‚îÄ */
async function fetchLP(url) {
  var res = { html: '', timing: null, error: null };
  var proxies = [
    'https://api.allorigins.win/get?url=' + encodeURIComponent(url),
    'https://corsproxy.io/?' + encodeURIComponent(url)
  ];
  var t0 = Date.now();
  for (var pi = 0; pi < proxies.length; pi++) {
    try {
      var controller = new AbortController();
      var timer = setTimeout(function() { controller.abort(); }, 12000);
      var r = await fetch(proxies[pi], { signal: controller.signal });
      clearTimeout(timer);
      if (r.ok) {
        res.timing = Date.now() - t0;
        var j = null;
        try { j = await r.json(); } catch(e2) {}
        res.html = (j && j.contents) ? j.contents : await r.text();
        res.html = res.html.substring(0, 60000);
        return res;
      }
    } catch(e) { continue; }
  }
  res.error = 'CORS blocked ‚Äî will infer from URL structure and domain';
  return res;
}

function extractSignals(html, url) {
  if (!html) return {};
  var s = {};
  try {
    var parser = new DOMParser();
    var doc = parser.parseFromString(html, 'text/html');
    s.title = doc.title || '';
    s.hasMobileVP = false;
    s.description = '';
    var metas = doc.querySelectorAll('meta');
    for (var mi = 0; mi < metas.length; mi++) {
      var m = metas[mi];
      if ((m.getAttribute('name') || '').toLowerCase() === 'viewport') s.hasMobileVP = true;
      if ((m.getAttribute('name') || '').toLowerCase() === 'description') s.description = m.getAttribute('content') || '';
    }
  } catch(e) {
    s.title = '';
    s.hasMobileVP = /viewport/i.test(html);
    s.description = '';
  }
  s.hasSSL = url.startsWith('https://');
  s.hasPrivacy = /privacy|policy/i.test(html);
  s.hasContact = /contact|phone|mobile|email|call us/i.test(html);
  s.hasRERA = /rera|mahrera|tnrera|hrera|krera|maharera/i.test(html);
  s.hasForm = /<form/i.test(html);
  s.hasCTA = /book now|schedule|enquire|enquiry|contact us|get quote|download brochure|call now|get details|register/i.test(html);
  s.hasSchema = /application\/ld\+json/i.test(html);
  s.hasLazy = /loading="lazy"|lazyload/i.test(html);
  s.imgCount = (html.match(/<img/gi) || []).length;
  s.scriptCount = (html.match(/<script/gi) || []).length;
  s.hasWebP = /\.webp/i.test(html);
  s.hasCDN = /cloudflare|fastly|cloudfront|jsdelivr|unpkg/i.test(html);
  s.hasH1 = /<h1/i.test(html);
  s.hasAltTags = !/(<img(?![^>]*\balt\s*=)[^>]*>)/i.test(html);
  s.hasCookieBanner = /cookie|gdpr|consent/i.test(html);
  s.hasGA = /google-analytics|gtag|UA-[0-9]|G-[A-Z0-9]/i.test(html);
  s.hasFB = /fbq\(|facebook pixel|connect\.facebook/i.test(html);
  s.hasTestimonial = /testimonial|review|rating|\bstars\b|verified buyer/i.test(html);
  s.hasPricing = /\u20b9|lakh|crore|price|cost|starting from/i.test(html);
  s.has360 = /360|virtual tour|walkthrough/i.test(html);
  s.hasChatWidget = /tawk|intercom|drift|crisp|freshchat|livechat|hubspot/i.test(html);
  return s;
}

/* ‚îÄ‚îÄ PROMPT BUILDER ‚îÄ‚îÄ */
function buildPrompt(headline, body, lpUrl, propType, country, platLabel, hasText, hasImages, hasLP, signals, lpData) {
  var p = '# Real Estate Ad Compliance Audit\n\n';
  p += '**Platform:** ' + platLabel + '\n';
  p += '**Property Type:** ' + propType + '\n';
  p += '**Target Country:** ' + country + '\n\n';
  p += '## INPUTS:\n';
  p += '- Ad Copy: ' + (hasText ? 'YES' : 'NO ‚Äî omit this section') + '\n';
  p += '- Creative Images: ' + (hasImages ? 'YES ‚Äî ' + gImages.length + ' image(s) follow this text' : 'NO ‚Äî omit this section') + '\n';
  p += '- Landing Page: ' + (hasLP ? 'YES ‚Äî ' + lpUrl : 'NO ‚Äî omit this section') + '\n\n';

  if (hasText) {
    p += '---\n## AD COPY TO AUDIT:\n';
    if (headline) p += '**Headline:** "' + headline + '"\n';
    if (body) p += '**Body:** "' + body + '"\n\n';
    p += 'Check thoroughly:\n';
    p += '1. Discriminatory language (religion, caste, community, gender, family status)\n';
    p += '2. False/unverifiable claims ‚Äî "guaranteed returns", "best rates", "100% safe"\n';
    p += '3. Missing disclosures ‚Äî RERA registration number, project ID, approvals\n';
    p += '4. Platform policy violations specific to ' + platLabel + '\n';
    p += '5. Superlatives requiring substantiation\n';
    p += '6. Investment claims (SEBI/RBI compliance for India)\n';
    p += '7. Character limits: Meta primary text optimal <125 chars, Google headlines ‚â§30 chars\n';
    p += '8. Urgency/scarcity claims that may be deceptive\n\n';
  }

  if (hasImages) {
    p += '---\n## CREATIVE IMAGE ANALYSIS (' + gImages.length + ' image(s) attached):\n\n';
    p += 'IMPORTANT: Carefully analyze every attached image.\n\n';
    p += '### For Meta Ads:\n';
    p += '- Estimate text overlay % (flag if >20%)\n';
    p += '- Prohibited content (before/after, misleading renders, financial guarantees in image)\n';
    p += '- Resolution ‚â•1080px, no blurring, no watermarks\n';
    p += '- Equal Housing Opportunity logo (US)\n\n';
    p += '### For Google Ads:\n';
    p += '- Image quality standards (no borders, excessive text)\n';
    p += '- Brand logo visibility\n';
    p += '- Misleading imagery\n\n';
    p += '### Real Estate Specific:\n';
    p += '- RERA disclaimer visible\n';
    p += '- "Indicative image" / "Artist impression" notice on CGI renders\n';
    p += '- Amenities shown must be approved/existing\n';
    p += '- Price claims in image must match approved pricing\n\n';
    p += 'Report findings per image: Image 1, Image 2, etc.\n\n';
  }

  if (hasLP) {
    p += '---\n## LANDING PAGE AUDIT: ' + lpUrl + '\n\n';
    if (signals && Object.keys(signals).length > 0) {
      p += '### Live-Crawled Signals:\n';
      p += '- SSL/HTTPS: ' + (signals.hasSSL ? 'YES' : 'NO ‚Äî CRITICAL ISSUE') + '\n';
      p += '- Mobile viewport: ' + (signals.hasMobileVP ? 'Present' : 'MISSING') + '\n';
      p += '- Title: ' + (signals.title ? '"' + signals.title.substring(0,80) + '"' : 'Not found') + '\n';
      p += '- Meta description: ' + (signals.description ? '"' + signals.description.substring(0,120) + '"' : 'MISSING') + '\n';
      p += '- RERA on page: ' + (signals.hasRERA ? 'Detected' : 'NOT FOUND') + '\n';
      p += '- Privacy policy: ' + (signals.hasPrivacy ? 'Found' : 'NOT FOUND') + '\n';
      p += '- Contact info: ' + (signals.hasContact ? 'Found' : 'NOT FOUND') + '\n';
      p += '- Lead form: ' + (signals.hasForm ? 'Present' : 'Not detected') + '\n';
      p += '- CTA: ' + (signals.hasCTA ? 'Found' : 'Weak/missing') + '\n';
      p += '- Images: ' + signals.imgCount + ' | WebP: ' + (signals.hasWebP ? 'Yes' : 'No') + ' | Lazy load: ' + (signals.hasLazy ? 'Yes' : 'No') + '\n';
      p += '- JS scripts: ' + signals.scriptCount + '\n';
      p += '- CDN: ' + (signals.hasCDN ? 'Detected' : 'Not detected') + '\n';
      p += '- Schema.org: ' + (signals.hasSchema ? 'Present' : 'Missing') + '\n';
      p += '- Google Analytics/GTM: ' + (signals.hasGA ? 'Detected' : 'Not detected') + '\n';
      p += '- Meta Pixel: ' + (signals.hasFB ? 'Detected' : 'Not detected') + '\n';
      p += '- Cookie consent: ' + (signals.hasCookieBanner ? 'Present' : 'Missing') + '\n';
      p += '- Testimonials: ' + (signals.hasTestimonial ? 'Found' : 'Not detected') + '\n';
      p += '- 360/Virtual tour: ' + (signals.has360 ? 'Found' : 'Not detected') + '\n';
      p += '- Pricing info: ' + (signals.hasPricing ? 'Found' : 'Not visible') + '\n';
      if (lpData && lpData.timing) p += '- Server response time: ' + lpData.timing + 'ms\n';
      p += '\n';
    } else {
      p += '**Note:** Live crawl was blocked. Analyze based on URL structure, domain name, industry standards, and provide a full audit with assumptions clearly stated.\n\n';
    }

    p += '### Provide these analysis sections:\n\n';
    p += '**1. PERFORMANCE SCORE (0‚Äì100 scale like Lighthouse):**\n';
    p += 'Give individual scores for: Performance, Accessibility, Best Practices, SEO\n';
    p += 'Estimate Core Web Vitals: LCP / INP / CLS with pass/fail vs Google thresholds\n';
    p += 'Mobile speed tier: Fast (<2s) / Moderate (2‚Äì4s) / Slow (>4s)\n\n';
    p += '**2. COMPLIANCE:**\n';
    p += '- RERA registration visible & linked to official portal\n';
    p += '- Possession date, carpet area disclosure, price breakup\n';
    p += '- Privacy policy (required by Meta/Google for ad destination pages)\n';
    p += '- Refund/cancellation policy\n';
    p += '- Builder license and approvals\n\n';
    p += '**3. UX & CONVERSION:**\n';
    p += '- Above-fold assessment\n';
    p += '- CTA strength and positioning\n';
    p += '- Form optimization\n';
    p += '- Trust signals\n';
    p += '- Mobile experience\n\n';
    p += '**4. TOP 5 PRIORITY FIXES:**\n';
    p += 'Each fix: Issue | Regulation/Impact | Step-by-step implementation | Expected improvement\n\n';
  }

  p += '---\n## REQUIRED OUTPUT STRUCTURE:\n\n';
  if (hasText) p += '## üìù Ad Copy Analysis\n';
  if (hasImages) p += '## üñºÔ∏è Creative Analysis\n';
  if (hasLP) {
    p += '## ‚ö° Performance Audit\n';
    p += '## ‚úÖ Compliance Check\n';
    p += '## üéØ Conversion Optimization\n';
  }
  p += '## üöÄ Priority Action List\n\n';
  p += 'Rules: Use ‚ùå FAIL, ‚ö†Ô∏è WARNING, ‚úÖ PASS prefix on every finding. Be exhaustive. Quote exact policy names. Give step-by-step fixes with expected impact.';
  return p;
}

/* ‚îÄ‚îÄ MAIN ANALYSIS ‚îÄ‚îÄ */
async function runAnalysis() {
  var headline = document.getElementById('adHeadline').value.trim();
  var body = document.getElementById('adBody').value.trim();
  var lpUrl = document.getElementById('lpUrl').value.trim();
  var propType = document.getElementById('propType').value;
  var country = document.getElementById('country').value;

  var hasText = !!(headline || body);
  var hasImages = gImages.length > 0;
  var hasLP = !!lpUrl;

  if (!hasText && !hasImages && !hasLP) {
    alert('Please provide at least one input: Ad Copy, Creative Images, or Landing Page URL.');
    return;
  }

  document.getElementById('analyzeBtn').disabled = true;
  document.getElementById('results').classList.remove('show');
  document.getElementById('results').innerHTML = '';

  var steps = [];
  if (hasText) steps.push({ id: 'copy', icon: 'üìù', label: 'Analyzing ad copy' });
  if (hasImages) steps.push({ id: 'img', icon: 'üñºÔ∏è', label: 'AI Vision scanning ' + gImages.length + ' image(s)' });
  if (hasLP) {
    steps.push({ id: 'fetch', icon: 'üåê', label: 'Fetching landing page' });
    steps.push({ id: 'perf', icon: '‚ö°', label: 'Extracting performance signals' });
  }
  steps.push({ id: 'ai', icon: 'ü§ñ', label: 'AI compliance analysis' });
  steps.push({ id: 'report', icon: 'üìä', label: 'Rendering report' });
  initProgress(steps);

  if (hasText) setStep('copy', 'active');
  if (hasImages) setStep('img', 'active');

  var lpData = null;
  var signals = {};

  try {
    if (hasLP) {
      setStep('fetch', 'active');
      lpData = await fetchLP(lpUrl);
      if (lpData.html) {
        signals = extractSignals(lpData.html, lpUrl);
        setStep('fetch', 'done', Math.round(lpData.html.length / 1024) + 'KB fetched');
      } else {
        setStep('fetch', 'failed', 'Proxy blocked ‚Äî AI infers');
        signals = { hasSSL: lpUrl.startsWith('https://') };
      }
      setStep('perf', 'active');
      setStep('perf', 'done', 'Signals ready');
    }

    setStep('ai', 'active');

    var platLabel = gPlatform === 'both' ? 'Meta Ads & Google Ads' : gPlatform === 'meta' ? 'Meta Ads' : 'Google Ads';
    var promptText = buildPrompt(headline, body, lpUrl, propType, country, platLabel, hasText, hasImages, hasLP, signals, lpData);

    var msgContent = [{ type: 'text', text: promptText }];
    for (var ii = 0; ii < gImages.length; ii++) {
      var imgObj = gImages[ii];
      var mtype = imgObj.type;
      if (!mtype || mtype.indexOf('image/') !== 0) mtype = 'image/jpeg';
      msgContent.push({
        type: 'image',
        source: { type: 'base64', media_type: mtype, data: imgObj.data.split(',')[1] }
      });
    }

    var response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 8000,
        system: 'You are a senior real estate digital advertising compliance expert with deep knowledge of Meta Ads policies, Google Ads policies, RERA India (MahaRERA, TNRERA, HRERA, KRERA), Fair Housing Act, Consumer Protection Act, and all global real estate advertising laws. You must analyze ALL provided inputs thoroughly. For images attached: examine every pixel, estimate text overlay percentage precisely, check all compliance requirements. For landing pages: provide detailed performance scoring like Google Lighthouse, check every compliance requirement. Never skip anything. Be comprehensive, specific, and cite exact policy names and regulation numbers.',
        messages: [{ role: 'user', content: msgContent }]
      })
    });

    if (!response.ok) {
      var errBody = null;
      try { errBody = await response.json(); } catch(e2) {}
      var errMsg = errBody && errBody.error ? errBody.error.message : 'HTTP ' + response.status;
      throw new Error(errMsg);
    }

    var data = await response.json();
    var resultText = data.content[0].text;

    if (hasText) setStep('copy', 'done');
    if (hasImages) setStep('img', 'done', gImages.length + ' image(s) analyzed');
    setStep('ai', 'done');
    setStep('report', 'active');

    gAnalysisContext = resultText.substring(0, 4000);
    renderResults(resultText, signals, hasLP, lpUrl, lpData);
    setStep('report', 'done', 'Complete');

  } catch(err) {
    setStep('ai', 'failed');
    setStep('report', 'failed');
    document.getElementById('results').innerHTML =
      '<div class="err-box"><strong>‚ö†Ô∏è Analysis Error</strong>' +
      escHtml(err.message) +
      '<br><br>If the error persists, check that the Anthropic API is accessible from this environment.</div>';
    document.getElementById('results').classList.add('show');
  } finally {
    document.getElementById('analyzeBtn').disabled = false;
  }
}

function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

/* ‚îÄ‚îÄ RENDER RESULTS ‚îÄ‚îÄ */
function renderResults(text, signals, hasLP, lpUrl, lpData) {
  var sections = parseSections(text);
  var overall = getOverall(text);

  var html = '<div class="res-header">' +
    '<div class="res-title">Compliance Report</div>' +
    '<div class="overall-pill ' + overall.cls + '">' + overall.label + '</div></div>';

  // Score cards if LP data exists
  if (hasLP && signals && Object.keys(signals).length > 0) {
    var pf = calcPerf(signals, lpData);
    var co = calcComp(signals);
    var cv = calcConv(signals);
    var se = calcSEO(signals);
    html += '<div class="sec-card" style="border-color:rgba(61,127,255,.18)">' +
      '<div class="sec-head open" onclick="toggleSec(\'scores\')">' +
      '<div class="sec-head-left"><span class="sec-ico">üìä</span>' +
      '<span class="sec-ttl">Live Audit Scores ‚Äî ' + lpUrl.replace(/https?:\/\//,'').substring(0,35) + '</span></div>' +
      '<div class="sec-right"><span class="pill pill-info">Lighthouse-style</span>' +
      '<span class="chev open" id="chev-scores">‚ñº</span></div></div>' +
      '<div class="sec-body open" id="body-scores">' +
      '<div class="score-grid">' +
      mkScore('Performance', pf) + mkScore('Compliance', co) +
      mkScore('Conversion', cv) + mkScore('SEO', se) +
      '</div></div></div>';
  }

  var secIcons = { 'Ad Copy': 'üìù', 'Creative': 'üñºÔ∏è', 'Image': 'üñºÔ∏è',
    'Performance': '‚ö°', 'Compliance': '‚úÖ', 'Conversion': 'üéØ', 'Priority': 'üöÄ' };

  for (var si = 0; si < sections.length; si++) {
    var sec = sections[si];
    var secId = 'sec' + si;
    var st = getSectionStatus(sec.body);
    var ico = 'üìã';
    for (var k in secIcons) {
      if (sec.title.indexOf(k) !== -1) { ico = secIcons[k]; break; }
    }
    var isOpen = si === 0 || sec.title.indexOf('Priority') !== -1 || sec.title.indexOf('Action') !== -1;
    html += '<div class="sec-card">' +
      '<div class="sec-head ' + (isOpen ? 'open' : '') + '" onclick="toggleSec(\'' + secId + '\')">' +
      '<div class="sec-head-left"><span class="sec-ico">' + ico + '</span>' +
      '<span class="sec-ttl">' + escHtml(sec.title) + '</span></div>' +
      '<div class="sec-right"><span class="pill ' + st.cls + '">' + st.label + '</span>' +
      '<span class="chev ' + (isOpen ? 'open' : '') + '" id="chev-' + secId + '">‚ñº</span>' +
      '</div></div>' +
      '<div class="sec-body ' + (isOpen ? 'open' : '') + '" id="body-' + secId + '">' +
      mdToHtml(sec.body) + '</div></div>';
  }

  html += '<div class="sec-card" style="border-color:rgba(61,127,255,.12)">' +
    '<div class="sec-head" onclick="toggleSec(\'aiask\')">' +
    '<div class="sec-head-left"><span class="sec-ico">ü§ñ</span>' +
    '<span class="sec-ttl">Ask AI for Deeper Analysis</span></div>' +
    '<div class="sec-right"><span class="chev" id="chev-aiask">‚ñº</span></div></div>' +
    '<div class="sec-body" id="body-aiask">' +
    '<p>Use the <strong>üí¨ chat</strong> (bottom-right) to ask follow-up questions. The AI has full context of your report.</p>' +
    '<p>Try: <em>"How do I fix the RERA compliance issue?"</em> or <em>"What\'s the exact Meta policy on image text?"</em></p>' +
    '</div></div>';

  document.getElementById('results').innerHTML = html;
  document.getElementById('results').classList.add('show');
  setTimeout(function() {
    document.getElementById('results').scrollIntoView({ behavior: 'smooth', block: 'start' });
  }, 200);
}

function toggleSec(id) {
  var body = document.getElementById('body-' + id);
  var head = body ? body.previousElementSibling : null;
  var chev = document.getElementById('chev-' + id);
  if (!body) return;
  var isOpen = body.classList.toggle('open');
  if (head) head.classList.toggle('open', isOpen);
  if (chev) chev.classList.toggle('open', isOpen);
}

/* ‚îÄ‚îÄ SCORE CALC ‚îÄ‚îÄ */
function calcPerf(s, lp) {
  var v = 68;
  if (s.hasSSL) v += 5;
  if (s.hasLazy) v += 5;
  if (s.hasWebP) v += 5;
  if (s.hasCDN) v += 5;
  if (s.scriptCount > 20) v -= 10;
  if (s.scriptCount > 30) v -= 8;
  if (s.imgCount > 30) v -= 5;
  if (!s.hasMobileVP) v -= 10;
  if (lp && lp.timing) {
    if (lp.timing < 700) v += 6;
    else if (lp.timing > 3000) v -= 15;
    else if (lp.timing > 1500) v -= 7;
  }
  return Math.max(10, Math.min(100, v));
}
function calcComp(s) {
  var v = 45;
  if (s.hasSSL) v += 20;
  if (s.hasRERA) v += 15;
  if (s.hasPrivacy) v += 12;
  if (s.hasContact) v += 8;
  return Math.min(100, v);
}
function calcConv(s) {
  var v = 35;
  if (s.hasForm) v += 18;
  if (s.hasCTA) v += 15;
  if (s.hasTestimonial) v += 12;
  if (s.hasChatWidget) v += 8;
  if (s.hasPricing) v += 10;
  if (s.has360) v += 5;
  return Math.min(100, v);
}
function calcSEO(s) {
  var v = 45;
  if (s.title) v += 12;
  if (s.description) v += 10;
  if (s.hasSchema) v += 15;
  if (s.hasH1) v += 5;
  if (s.hasAltTags) v += 5;
  if (s.hasSSL) v += 5;
  return Math.min(100, v);
}

function mkScore(label, val) {
  var cls = val >= 80 ? 's-green' : val >= 60 ? 's-yellow' : 's-red';
  return '<div class="score-item ' + cls + '">' +
    '<div class="score-label">' + label + '</div>' +
    '<div class="score-val">' + val + '</div>' +
    '<div class="score-bar"><div class="score-fill" style="width:' + val + '%;"></div></div>' +
    '</div>';
}

/* ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ */
function parseSections(md) {
  var parts = md.split(/(?=^## )/m).filter(function(p) { return p.trim(); });
  return parts.map(function(p) {
    var m = p.match(/^## (.+)/m);
    var title = m ? m[1].trim() : 'Analysis';
    var body = p.replace(/^## .+\n?/m, '').trim();
    return { title: title, body: body };
  });
}

function getSectionStatus(text) {
  var fails = (text.match(/‚ùå/g) || []).length;
  var warns = (text.match(/‚ö†Ô∏è/g) || []).length;
  if (fails > 0) return { cls: 'pill-fail', label: fails + (fails === 1 ? ' issue' : ' issues') };
  if (warns > 0) return { cls: 'pill-warn', label: warns + (warns === 1 ? ' warning' : ' warnings') };
  return { cls: 'pill-pass', label: '‚úì Passed' };
}

function getOverall(text) {
  var fails = (text.match(/‚ùå/g) || []).length;
  var warns = (text.match(/‚ö†Ô∏è/g) || []).length;
  if (fails > 3) return { cls: 'pill-fail', label: '‚ùå ' + fails + ' Issues' };
  if (fails > 0) return { cls: 'pill-warn', label: '‚ö†Ô∏è ' + fails + ' Issue' + (fails > 1 ? 's' : '') + ' Found' };
  if (warns > 3) return { cls: 'pill-warn', label: '‚ö†Ô∏è Review Recommended' };
  return { cls: 'pill-pass', label: '‚úÖ Compliant' };
}

function mdToHtml(md) {
  var r = md;
  r = r.replace(/^### (.+)$/gm, '<h4>$1</h4>');
  r = r.replace(/^## (.+)$/gm, '<h3>$1</h3>');
  r = r.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  r = r.replace(/\*(.+?)\*/g, '<em>$1</em>');
  r = r.replace(/`([^`]+)`/g, '<code>$1</code>');
  r = r.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');
  r = r.replace(/^> (.+)$/gm, '<blockquote>$1</blockquote>');
  r = r.replace(/^(\d+)\.\s+(.+)$/gm, '<li>$2</li>');
  r = r.replace(/^[-‚Ä¢*]\s+(.+)$/gm, '<li>$1</li>');
  r = r.replace(/(<li>.*?<\/li>)/g, function(m) { return '<ul>' + m + '</ul>'; });
  r = r.replace(/<\/ul>\s*<ul>/g, '');
  var parts = r.split(/\n{2,}/);
  r = parts.map(function(p) {
    p = p.trim();
    if (!p) return '';
    if (/^<[huo]/.test(p) || /^<blockquote/.test(p)) return p;
    return '<p>' + p.replace(/\n/g, '<br>') + '</p>';
  }).join('\n');
  return r;
}

/* ‚îÄ‚îÄ CHATBOT ‚îÄ‚îÄ */
function toggleChat() {
  gChatOpen = !gChatOpen;
  document.getElementById('chatPanel').classList.toggle('open', gChatOpen);
  document.getElementById('fab').innerHTML = gChatOpen ? '‚úï' : 'üí¨';
  if (gChatOpen) {
    setTimeout(function() { document.getElementById('chatInput').focus(); }, 350);
  }
}

function addChatMsg(role, text) {
  var msgs = document.getElementById('chatMsgs');
  var div = document.createElement('div');
  div.className = 'cmsg ' + role;
  div.innerHTML = '<div class="cmsg-av">' + (role === 'ai' ? 'AI' : 'U') + '</div>' +
    '<div class="cbubble">' + escHtml(text).replace(/\n/g, '<br>') + '</div>';
  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;
}

function showTypingIndicator() {
  var msgs = document.getElementById('chatMsgs');
  var div = document.createElement('div');
  div.className = 'cmsg ai';
  div.id = 'typing-dot';
  div.innerHTML = '<div class="cmsg-av">AI</div><div class="typing"><span></span><span></span><span></span></div>';
  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;
}

function removeTypingIndicator() {
  var el = document.getElementById('typing-dot');
  if (el) el.remove();
}

function useSugg(btn) {
  document.getElementById('chatInput').value = btn.textContent;
  sendChat();
}

function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 100) + 'px';
}

function chatKeyDown(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendChat(); }
}

async function sendChat() {
  var input = document.getElementById('chatInput');
  var txt = input.value.trim();
  if (!txt) return;

  addChatMsg('user', txt);
  gChatHistory.push({ role: 'user', content: txt });
  input.value = '';
  input.style.height = 'auto';
  document.getElementById('chatSendBtn').disabled = true;
  document.getElementById('chatSuggs').style.display = 'none';
  showTypingIndicator();

  try {
    var sys = 'You are an expert real estate advertising compliance consultant with deep knowledge of Meta Ads, Google Ads, RERA India, Fair Housing laws, and global real estate advertising regulations. Provide concise, actionable answers. Use bullet points for lists. Maximum ~200 words per response unless user asks for detail.';
    if (gAnalysisContext) {
      sys += '\n\nContext from recent analysis on this session:\n' + gAnalysisContext.substring(0, 2500);
    }

    var msgs = gChatHistory.slice(-14);
    var resp = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1024,
        system: sys,
        messages: msgs
      })
    });

    var d = await resp.json();
    var reply = d.content[0].text;
    gChatHistory.push({ role: 'assistant', content: reply });
    removeTypingIndicator();
    addChatMsg('ai', reply);

  } catch(e) {
    removeTypingIndicator();
    addChatMsg('ai', 'Connection error: ' + e.message);
  } finally {
    document.getElementById('chatSendBtn').disabled = false;
  }
}
</script>
</body>
</html>
